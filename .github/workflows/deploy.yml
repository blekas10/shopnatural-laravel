name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual deployment from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }} 
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "ğŸš€ Starting deployment..."

          # Navigate to project directory
          cd ${{ secrets.PROJECT_PATH }}

          # Backup current state (optional but recommended)
          echo "ğŸ“¦ Creating backup..."
          php artisan down || true

          # Pull latest changes
          echo "â¬‡ï¸ Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main

          # Install/update Composer dependencies (production only)
          echo "ğŸ“š Installing Composer dependencies..."
          composer install --no-dev --optimize-autoloader --no-interaction

          # Install/update NPM dependencies and build assets
          echo "ğŸ¨ Building frontend assets..."
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          npm ci --production=false
          npm run build

          # Run database migrations
          echo "ğŸ—„ï¸ Running migrations..."
          php artisan migrate --force

          # Clear all caches
          echo "ğŸ§¹ Clearing caches..."
          php artisan cache:clear
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear

          # Recreate optimized caches
          echo "âš¡ Optimizing application..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan event:cache

          # Restart queue workers
          echo "ğŸ”„ Restarting queue workers..."
          php artisan queue:restart

          # Bring application back up
          echo "âœ… Bringing application online..."
          php artisan up

          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“… Deployed at: $(date)"

    - name: Deployment notification
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Deployment succeeded!"
        else
          echo "âŒ Deployment failed!"
        fi
